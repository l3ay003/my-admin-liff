<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบแจ้งซ่อมรถยนต์</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root { --gov-green: #2E7D32; --gov-light: #E8F5E9; }
        body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
        .navbar { background-color: var(--gov-green) !important; color: white; }
        .card-header { background-color: var(--gov-green); color: white; font-weight: bold; }
        .btn-gov { background-color: var(--gov-green); color: white; }
        .btn-gov:hover { background-color: #1b5e20; color: white; }
        .status-badge { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; }
        .floating-btn { position: fixed; bottom: 20px; right: 20px; border-radius: 50%; width: 60px; height: 60px; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
    <div class="container">
        <span class="navbar-brand"><i class="bi bi-truck-flatbed"></i> ระบบแจ้งซ่อมรถยนต์</span>
        <div id="userProfile" class="d-flex align-items-center text-white">
            <img id="userImg" src="" width="35" class="rounded-circle me-2">
            <small id="userNameDisplay"></small>
        </div>
    </div>
</nav>

<div class="container pb-5">
    <div id="adminStats" class="row g-3 mb-4 d-none">
        <div class="col-6 col-md-3">
            <div class="card text-center p-3 border-0 shadow-sm">
                <h3 class="text-warning" id="countPending">0</h3>
                <small>รอดำเนินการ</small>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center p-3 border-0 shadow-sm">
                <h3 class="text-primary" id="countFixing">0</h3>
                <small>กำลังซ่อม</small>
            </div>
        </div>
        </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>รายการแจ้งซ่อมของท่าน</span>
            <button class="btn btn-sm btn-light" onclick="showRepairModal()"><i class="bi bi-plus-lg"></i> แจ้งซ่อม</button>
        </div>
        <div class="card-body p-0">
            <div id="repairList" class="list-group list-group-flush">
                <div class="p-5 text-center text-muted">กำลังโหลดข้อมูล...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="repairModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
            <form id="repairForm">
                <div class="modal-header">
                    <h5 class="modal-title">ข้อมูลการแจ้งซ่อม</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">เลขทะเบียนรถ</label>
                        <select class="form-select" id="carPlate" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">เลขไมล์ (กม.)</label>
                        <input type="number" class="form-control" id="mileage" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">รายละเอียดอาการเสีย</label>
                        <textarea class="form-control" id="details" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ประเมินค่าใช้จ่าย (บาท)</label>
                        <input type="number" class="form-control" id="estCost">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">สถานที่ซ่อม</label>
                        <input type="text" class="form-control" id="location">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-gov w-100">ส่งแจ้งซ่อมรถยนต์</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const LIFF_ID = "2009201666-JexzIIEn"; 
const GAS_URL = "https://script.google.com/macros/s/AKfycbyVmkVoJnDEr1gTDCFazu8wQzKV58wMewwxnmEwAeO-sgkCYpZQ74nRwGvIgNcsZmhJFw/exec"; 

let userData = {};

// 1. เริ่มต้นระบบ LIFF
async function main() {
    try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            getUserStatus();
        }
    } catch (err) {
        console.error("LIFF Initialization failed", err);
    }
}

// 2. ตรวจสอบสิทธิ์และข้อมูลผู้ใช้จาก GAS
function getUserStatus() {
    const idToken = liff.getIDToken();
    fetch(`${GAS_URL}?action=checkUser&idToken=${idToken}`)
        .then(res => res.json())
        .then(data => {
            userData = data;
            document.getElementById('userImg').src = data.picture;
            document.getElementById('userNameDisplay').innerText = data.name;
            
            // แสดงผลตาม Role
            if (data.role === 'Admin') {
                document.getElementById('adminStats').classList.remove('d-none');
            }
            
            loadInitialData();
        });
}

// 3. โหลดข้อมูลทะเบียนรถและรายการแจ้งซ่อม
function loadInitialData() {
    fetch(`${GAS_URL}?action=getInitialData&userId=${userData.userId}&role=${userData.role}`)
        .then(res => res.json())
        .then(data => {
            // ใส่ข้อมูลทะเบียนรถใน Select
            const carSelect = document.getElementById('carPlate');
            carSelect.innerHTML = '<option value="">เลือกทะเบียนรถ</option>';
            data.cars.forEach(car => {
                if(car[0]) carSelect.innerHTML += `<option value="${car[0]}">${car[0]}</option>`;
            });

            // แสดงสถิติ (ถ้าเป็น Admin)
            if (userData.role === 'Admin') {
                updateAdminStats(data.myRequests);
            }

            renderRepairList(data.myRequests);
        });
}

// 4. แสดงรายการแจ้งซ่อมในหน้าจอ
function renderRepairList(requests) {
    const listDiv = document.getElementById('repairList');
    if (requests.length === 0) {
        listDiv.innerHTML = '<div class="p-5 text-center text-muted">ไม่พบข้อมูลการแจ้งซ่อม</div>';
        return;
    }

    listDiv.innerHTML = requests.map(item => `
        <div class="list-group-item p-3">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6 class="mb-1 fw-bold">${item.plate}</h6>
                    <small class="text-muted">อาการ: ${item.details}</small><br>
                    <small class="text-muted">ผู้แจ้ง: ${item.userName}</small>
                </div>
                <span class="status-badge ${getStatusClass(item.status)}">${item.status}</span>
            </div>
            ${item.remark ? `<div class="mt-2 small text-danger"><b>หมายเหตุ:</b> ${item.remark}</div>` : ''}
            <div class="mt-2 d-flex justify-content-between align-items-center">
                <small class="text-muted"><i class="bi bi-clock"></i> ${new Date(item.timestamp).toLocaleDateString('th-TH')}</small>
                ${userData.role === 'Admin' ? `<button class="btn btn-sm btn-outline-primary" onclick="manageTask('${item.jobId}')">จัดการ</button>` : ''}
            </div>
        </div>
    `).join('');
}

// ฟังก์ชันเสริม: เปลี่ยนสีตามสถานะ
function getStatusClass(status) {
    switch(status) {
        case 'รอดำเนินการ': return 'bg-warning text-dark';
        case 'กำลังซ่อม': return 'bg-primary text-white';
        case 'เสร็จสิ้น': return 'bg-success text-white';
        case 'ส่งกลับแก้ไข': return 'bg-danger text-white';
        default: return 'bg-secondary text-white';
    }
}

// 5. ส่งข้อมูลแจ้งซ่อมใหม่
document.getElementById('repairForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    btn.disabled = true;
    btn.innerText = "กำลังส่งข้อมูล...";

    const payload = {
        action: 'submitRepair',
        userId: userData.userId,
        userName: userData.name, // ชื่อจริงจาก Sheet ที่ GAS ส่งมาให้
        plate: document.getElementById('carPlate').value,
        mileage: document.getElementById('mileage').value,
        details: document.getElementById('details').value,
        cost: document.getElementById('estCost').value,
        location: document.getElementById('location').value
    };

    fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(res => {
        if(res.success) {
            alert('ส่งข้อมูลแจ้งซ่อมเรียบร้อยแล้ว');
            location.reload();
        }
    });
});

// ฟังก์ชันเปิด Modal
function showRepairModal() {
    new bootstrap.Modal(document.getElementById('repairModal')).show();
}

main();
</script>
</body>
</html>

